<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>股票</title>
      <link href="/2021/10/22/%E8%82%A1%E7%A5%A8/"/>
      <url>/2021/10/22/%E8%82%A1%E7%A5%A8/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>FPGA</title>
      <link href="/2021/10/19/%E7%8A%B6%E6%80%81%E6%9C%BA%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/"/>
      <url>/2021/10/19/%E7%8A%B6%E6%80%81%E6%9C%BA%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<p><em><strong>状态机在FPGA设计中具有十分重要的地位，可以实现类似单片机一样的按一定流程“执行”。</strong></em></p><span id="more"></span><h1 id="状态机的定义"><a href="#状态机的定义" class="headerlink" title="状态机的定义"></a>状态机的定义</h1><p>​        <strong>状态机</strong>就是将一个复杂的问题分为很多个步骤，这一步做好了才能去到下一步。比如说实现一个i2c协议发送单字节数据过程，第一步是发送地址；第二步是等待应答，应答成功后进入第三部发送寄存器地址，失败则回到空闲态，然后再次等待发送信号；第四步也是等待应答，应带成功进入第五步发送一个字节数据，失败则返回空闲态，然后等待发送信号，从头开始；第六步等待应答，应答成功则发送stop信号，然后回到空闲态，等下一个发送信号，失败则回到空闲态等发送信号。当然，可以加入发送失败标志判断是否需要重新发送。</p><h1 id="状态机的描述方法"><a href="#状态机的描述方法" class="headerlink" title="状态机的描述方法"></a>状态机的描述方法</h1><table><thead><tr><th align="right">类型</th><th align="center">描述方法</th></tr></thead><tbody><tr><td align="right">一段式</td><td align="center">整个状态机写到一个always模块里面，在该模块中既描述状态转移，又描述状态的输入和输出；</td></tr><tr><td align="right">二段式</td><td align="center">用两个always模块来描述状态机，其中一个always模块采用同步时序描述状态转移；另一个模块采用组合逻辑判断状态转移条件，描述状态转移规律以及输出；</td></tr><tr><td align="right">三段式</td><td align="center">在两个always模块描述方法基础上，使用三个always模块，一个always模块采用同步时序描述状态转移，一个always采用组合逻辑判断状态转移条件，描述状态转移规律，另一个always模块描述状态输出(可以用组合电路输出，也可以时序电路输出)。</td></tr></tbody></table><center><font color="#dd00dd">二段式状态机的示例如下：</font><br></center> <figure class="highlight verilog"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一个进程，同步时序always模块，格式化描述次态寄存器迁移到现态寄存器</span></span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst_n)</span><br><span class="line">        curr_state &lt;= INIT;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        curr_state &lt;= next_state; <span class="comment">// 注意，使用的是非阻塞赋值</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第二个进程，采用组合逻辑判断状态转移条件，描述状态转移规律以及输出</span></span><br><span class="line"><span class="keyword">always</span> @ (*) <span class="keyword">begin</span>      <span class="comment">//电平触发,组合逻辑</span></span><br><span class="line"><span class="keyword">case</span>(current_state)</span><br><span class="line">S1: <span class="keyword">if</span>(...)</span><br><span class="line">            <span class="keyword">begin</span></span><br><span class="line">                    data_out = ...;</span><br><span class="line">next_state = S2; <span class="comment">//阻塞赋值</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    data_out = ...;</span><br><span class="line">next_state = S2; <span class="comment">//阻塞赋值</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">...:</span><br><span class="line"><span class="keyword">endcase</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure><center><font color="#dd00dd">三段式状态机的示例如下：</font><br></center> <figure class="highlight verilog"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一个进程，同步时序always模块，格式化描述次态寄存器迁移到现态寄存器</span></span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst_n)</span><br><span class="line">        curr_state &lt;= INIT;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        curr_state &lt;= next_state;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第二个进程，组合逻辑always模块，描述状态转移条件判断</span></span><br><span class="line"><span class="keyword">always</span> @ (*) <span class="keyword">begin</span>      <span class="comment">//电平触发,组合逻辑</span></span><br><span class="line"><span class="keyword">case</span>(current_state)</span><br><span class="line">S1: <span class="keyword">if</span>(...)</span><br><span class="line">            <span class="keyword">begin</span></span><br><span class="line">                    ...;             <span class="comment">//一些条件的判断</span></span><br><span class="line">next_state = S2; <span class="comment">//阻塞赋值</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    ...;             <span class="comment">//一些条件的判断</span></span><br><span class="line">next_state = S2; <span class="comment">//阻塞赋值</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">...:</span><br><span class="line"><span class="keyword">endcase</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst_n)</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">...; <span class="comment">//初始化</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span>(next_state)</span><br><span class="line">            S1:</span><br><span class="line">out1 &lt;= <span class="number">1'b1</span>; <span class="comment">//注意是非阻塞逻辑</span></span><br><span class="line">S2:</span><br><span class="line">out2 &lt;= <span class="number">1'b1</span>;</span><br><span class="line"><span class="keyword">default</span>:...;</span><br><span class="line"><span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure><center><font color="#dd00dd">两段式有限状态机与三段式有限状态机的区别</font><br></center> <p>​        <font color="#dd0000">FSM将时序部分（状态转移部分）和组合部分（判断状态转移条件和产生输出）分开，写为两个always语句，即为两段式有限状态机。将组合部分中的判断状态转移条件和产生输入再分开写，则为三段式有限状态机。<strong>二段式在组合逻辑特别复杂时适用，但要注意需在后面加一个触发器以消除组合逻辑对输出产生的毛刺。三段式没有这个问题，由于第三个always会生成触发器。</strong></font><br></p><h1 id="自动售货机示例"><a href="#自动售货机示例" class="headerlink" title="自动售货机示例"></a>自动售货机示例</h1><p>​        只列举了一种货物的情况：为6元的货物，只接受1元和5元的货币，当接受的钱足够时，会吐出货物。当在60个时钟周期内没投够6元时，自动回到初始状态，重新选择货物。货物每出货一个，总数减1，为0时重新装货，如此循环。</p><figure class="highlight verilog"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="meta-keyword">timescale</span> 1ns / 1ps</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> shopping_1(</span><br><span class="line">    <span class="keyword">input</span> clk,</span><br><span class="line">    <span class="keyword">input</span> rst_n,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">2</span>:<span class="number">0</span>] din,                           <span class="comment">// 投1元，5元</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">2</span>:<span class="number">0</span>] choose,                        <span class="comment">// 货物选择 1：6元，2：8元</span></span><br><span class="line">    <span class="keyword">input</span> confirm,                             <span class="comment">// 选择后确认货物</span></span><br><span class="line">    <span class="keyword">input</span> reconfirm,                           <span class="comment">// 确认后可以重新选择</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> dout,                           <span class="comment">// 出货</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">4</span>:<span class="number">0</span>] change,                   <span class="comment">// 找钱</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> empty_6                         <span class="comment">// 6元货物空信号</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="keyword">reg</span> [<span class="number">5</span>:<span class="number">0</span>] curr_state, next_state;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">4</span>:<span class="number">0</span>] count                 ;              <span class="comment">// 当前总金额 </span></span><br><span class="line"><span class="keyword">reg</span> [<span class="number">6</span>:<span class="number">0</span>] goods_6               ;              <span class="comment">// 初始63</span></span><br><span class="line"><span class="keyword">reg</span> [<span class="number">7</span>:<span class="number">0</span>] time_cnt              ;              <span class="comment">// 计时60s</span></span><br><span class="line"><span class="keyword">reg</span> time_out                    ;              <span class="comment">// 时间计数完信号</span></span><br><span class="line"><span class="keyword">reg</span> time_begin                  ;              <span class="comment">// 时间开始计数信号</span></span><br><span class="line"><span class="keyword">reg</span> [<span class="number">4</span>:<span class="number">0</span>] temp                  ;              <span class="comment">// 存放每个商品的价格，找钱用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------------货物全局初始化-------------------------</span></span><br><span class="line"><span class="keyword">parameter</span> INIT   = <span class="number">11</span>              ;              <span class="comment">// 货物不够就初始化装货</span></span><br><span class="line"><span class="keyword">parameter</span> IDLE   = <span class="number">22</span>              ;              <span class="comment">// 选择货物</span></span><br><span class="line"><span class="comment">// ------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------------6元货物状态：-------------------------</span></span><br><span class="line"><span class="keyword">parameter</span> S6_0   = <span class="number">1</span>              ;              <span class="comment">// 支付过程</span></span><br><span class="line"><span class="keyword">parameter</span> S6_1   = <span class="number">2</span>              ;              <span class="comment">// 满足金额出货</span></span><br><span class="line"><span class="comment">// ------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst_n)</span><br><span class="line">        curr_state &lt;= INIT;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        curr_state &lt;= next_state;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @功能: 计时60s</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span>        </span><br><span class="line">    <span class="keyword">if</span>(!rst_n)</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            time_cnt &lt;= <span class="number">8'd0</span>;</span><br><span class="line">            time_out &lt;= <span class="number">8'd0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(next_state == IDLE)</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            time_cnt &lt;= <span class="number">8'd0</span>;</span><br><span class="line">            time_out &lt;= <span class="number">8'd0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">if</span> (time_begin == <span class="number">1'd1</span>)</span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    <span class="keyword">if</span> (time_cnt &gt;= <span class="number">8'd60</span>)</span><br><span class="line">                        <span class="keyword">begin</span></span><br><span class="line">                            time_cnt &lt;= <span class="number">8'd0</span>;</span><br><span class="line">                            time_out &lt;= <span class="number">1'd1</span>;</span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">else</span> </span><br><span class="line">                        <span class="keyword">begin</span></span><br><span class="line">                            time_cnt &lt;= time_cnt + <span class="number">8'd1</span>;</span><br><span class="line">                            time_out &lt;= <span class="number">1'd0</span>;</span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    time_cnt &lt;= <span class="number">8'd0</span>;</span><br><span class="line">                    time_out &lt;= <span class="number">8'd0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @功能: 描述状态转移，和一些信号的产生。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">always</span> @(*) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">case</span> (curr_state)</span><br><span class="line">        INIT:</span><br><span class="line">            <span class="keyword">begin</span></span><br><span class="line">                time_begin = <span class="number">1'b0</span>;</span><br><span class="line">                goods_6 = <span class="number">7'd10</span>;</span><br><span class="line">                next_state = IDLE;</span><br><span class="line">                count = <span class="number">5'd0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        IDLE:</span><br><span class="line">            <span class="keyword">if</span>(empty_6 == <span class="number">1'b1</span>)</span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    time_begin = <span class="number">1'b0</span>;</span><br><span class="line">                    goods_6 = <span class="number">7'd10</span>;</span><br><span class="line">                    next_state = INIT;</span><br><span class="line">                    count = <span class="number">5'd0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    <span class="keyword">if</span>(choose == <span class="number">3'd1</span>)</span><br><span class="line">                        <span class="keyword">begin</span></span><br><span class="line">                            time_begin = <span class="number">1'b1</span>;</span><br><span class="line">                            goods_6 = goods_6;</span><br><span class="line">                            next_state = S6_0;</span><br><span class="line">                            count = <span class="number">5'd0</span>;</span><br><span class="line">                        <span class="keyword">end</span> </span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="keyword">begin</span></span><br><span class="line">                            time_begin = <span class="number">1'b0</span>;</span><br><span class="line">                            goods_6 = goods_6;</span><br><span class="line">                            next_state = IDLE;</span><br><span class="line">                            count = <span class="number">5'd0</span>;</span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">        S6_0:</span><br><span class="line">            <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span> (reconfirm == <span class="number">1'b1</span>)   <span class="comment">// 是否重新选择</span></span><br><span class="line">                    <span class="keyword">begin</span></span><br><span class="line">                        time_begin = <span class="number">0</span>;</span><br><span class="line">                        goods_6 = goods_6;</span><br><span class="line">                        count = <span class="number">5'd0</span>;</span><br><span class="line">                        next_state = IDLE;</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">else</span> </span><br><span class="line">                    <span class="keyword">begin</span></span><br><span class="line">                        <span class="keyword">if</span> (time_out == <span class="number">1'b0</span>)</span><br><span class="line">                            <span class="keyword">begin</span></span><br><span class="line">                                <span class="keyword">if</span> (count &gt;= <span class="number">5'd6</span>)</span><br><span class="line">                                    <span class="keyword">begin</span></span><br><span class="line">                                        time_begin = <span class="number">1'b0</span>;</span><br><span class="line">                                        count = count;</span><br><span class="line">                                        goods_6 = goods_6 - <span class="number">7'd1</span>;</span><br><span class="line">                                        next_state = S6_1;</span><br><span class="line">                                    <span class="keyword">end</span></span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    <span class="keyword">begin</span></span><br><span class="line">                                        count = count + din;</span><br><span class="line">                                        time_begin = time_begin;</span><br><span class="line">                                        goods_6 = goods_6;</span><br><span class="line">                                        next_state = S6_0; </span><br><span class="line">                                    <span class="keyword">end</span></span><br><span class="line">                            <span class="keyword">end</span></span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            <span class="keyword">begin</span></span><br><span class="line">                                count = count;</span><br><span class="line">                                goods_6 = goods_6;</span><br><span class="line">                                time_begin = <span class="number">1'b0</span>;</span><br><span class="line">                                next_state = IDLE;</span><br><span class="line">                            <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        S6_1:</span><br><span class="line">            <span class="keyword">begin</span></span><br><span class="line">                count = count;</span><br><span class="line">                goods_6 = goods_6 - <span class="number">7'd1</span>;</span><br><span class="line">                goods_6 = goods_6;</span><br><span class="line">                next_state = IDLE;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">default</span>: ;</span><br><span class="line">    <span class="keyword">endcase</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst_n)</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            dout &lt;= <span class="number">1'b0</span>;</span><br><span class="line">            change &lt;= <span class="number">5'd0</span>;</span><br><span class="line">            empty_6 &lt;= <span class="number">1'b0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">if</span>(curr_state == S6_0 &amp;&amp; time_out == <span class="number">1'b1</span>)</span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    change &lt;= count;</span><br><span class="line">                    dout &lt;= <span class="number">1'b0</span>;</span><br><span class="line">                    empty_6 &lt;= <span class="number">1'b0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(curr_state == S6_1)</span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    change &lt;= count - <span class="number">5'd6</span>;</span><br><span class="line">                    dout &lt;= <span class="number">1'b1</span>;</span><br><span class="line">                    <span class="keyword">if</span>(goods_6 &lt;= <span class="number">7'd0</span>)</span><br><span class="line">                        empty_6 &lt;= <span class="number">1'b1</span>;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        empty_6 &lt;= <span class="number">1'b0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    change &lt;= <span class="number">5'd0</span>;</span><br><span class="line">                    dout &lt;= <span class="number">1'b0</span>;</span><br><span class="line">                    empty_6 &lt;= <span class="number">1'b0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure><p>testbench文件：</p><figure class="highlight verilog"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="meta-keyword">timescale</span>  1ns / 1ps</span></span><br><span class="line"><span class="comment">//~ `New testbench </span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">choose 的时序还没有调整</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> tb_shopping_1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shopping_1 Parameters</span></span><br><span class="line"><span class="keyword">parameter</span> PERIOD = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">parameter</span> INIT  = <span class="number">11</span>;</span><br><span class="line"><span class="keyword">parameter</span> IDLE  = <span class="number">22</span>;</span><br><span class="line"><span class="keyword">parameter</span> S6_0  = <span class="number">1</span> ;</span><br><span class="line"><span class="keyword">parameter</span> S6_1  = <span class="number">2</span> ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shopping_1 Inputs</span></span><br><span class="line"><span class="keyword">reg</span>   clk                                           = <span class="number">0</span> ;</span><br><span class="line"><span class="keyword">reg</span>   rst_n                                         = <span class="number">0</span> ;</span><br><span class="line"><span class="keyword">reg</span>   [<span class="number">2</span>:<span class="number">0</span>]  din                                    = <span class="number">0</span> ;</span><br><span class="line"><span class="keyword">reg</span>   [<span class="number">2</span>:<span class="number">0</span>]  choose                                 = <span class="number">0</span> ;</span><br><span class="line"><span class="keyword">reg</span>   confirm                                       = <span class="number">0</span> ;</span><br><span class="line"><span class="keyword">reg</span>   reconfirm                                     = <span class="number">0</span> ;</span><br><span class="line"><span class="keyword">reg</span>   [<span class="number">10</span>:<span class="number">0</span>] count ,data_out                        = <span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shopping_1 Outputs</span></span><br><span class="line"><span class="keyword">wire</span>  dout                                 ;</span><br><span class="line"><span class="keyword">wire</span>  [<span class="number">4</span>:<span class="number">0</span>]  change                        ;</span><br><span class="line"><span class="keyword">wire</span>  empty_6                              ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">integer</span> i, fp, data, file_wr, fp1, data_choose, j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">initial</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">forever</span> <span class="variable">#(PERIOD/2)</span>  clk=~clk;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="variable">#(PERIOD*2)</span> rst_n  =  <span class="number">1</span>;</span><br><span class="line">    file_wr = <span class="built_in">$fopen</span>(<span class="string">"C:/Users/.../change.txt"</span>,<span class="string">"w"</span>);</span><br><span class="line">    fp = <span class="built_in">$fopen</span>(<span class="string">"C:/Users/.../money.txt"</span>, <span class="string">"r"</span>);</span><br><span class="line">    fp1 = <span class="built_in">$fopen</span>(<span class="string">"C:/Users/.../choose.txt"</span>, <span class="string">"r"</span>);</span><br><span class="line">    <span class="variable">#(PERIOD*10000)</span>;</span><br><span class="line">    <span class="built_in">$fclose</span>(fp);</span><br><span class="line">    <span class="built_in">$fclose</span>(fp1);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span> @ (<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n)<span class="keyword">begin</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!rst_n)<span class="keyword">begin</span></span><br><span class="line">        choose &lt;= <span class="number">0</span>;</span><br><span class="line">        data_choose &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; fp!=<span class="string">"\0"</span>;i=i+<span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            <span class="variable">#(PERIOD)</span>;</span><br><span class="line">            <span class="built_in">$fscanf</span>(fp, <span class="string">"%d"</span>, data);</span><br><span class="line">            din &lt;= data;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span> @ (<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n)<span class="keyword">begin</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!rst_n)<span class="keyword">begin</span></span><br><span class="line">        choose &lt;= <span class="number">0</span>;</span><br><span class="line">        data_choose &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">for</span> (j=<span class="number">0</span>; fp1!=<span class="string">"\0"</span>;j=j+<span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            <span class="variable">#(PERIOD)</span>;</span><br><span class="line">            <span class="built_in">$fscanf</span>(fp1, <span class="string">"%d"</span>, data_choose);</span><br><span class="line">            choose &lt;= data_choose;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span> @ (<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n)<span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst_n)<span class="keyword">begin</span></span><br><span class="line">        data_out&lt;=<span class="number">8'b0</span>;</span><br><span class="line">        count&lt;=<span class="number">11'b0</span>;</span><br><span class="line">        choose &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(count&lt;<span class="number">11'd100</span>) <span class="keyword">begin</span></span><br><span class="line">        data_out&lt;=change;</span><br><span class="line">        count&lt;=count+<span class="number">1'b1</span>;</span><br><span class="line">        <span class="built_in">$fdisplay</span>(file_wr,<span class="string">"%d"</span>,change);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        <span class="built_in">$fclose</span>(file_wr);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shopping_1 #(</span><br><span class="line">    <span class="variable">.INIT</span> ( INIT ),</span><br><span class="line">    <span class="variable">.IDLE</span> ( IDLE ),</span><br><span class="line">    <span class="variable">.S6_0</span> ( S6_0 ),</span><br><span class="line">    <span class="variable">.S6_1</span> ( S6_1 ))</span><br><span class="line"> u_shopping_1 (</span><br><span class="line">    <span class="variable">.clk</span>                     ( clk              ),</span><br><span class="line">    <span class="variable">.rst_n</span>                   ( rst_n            ),</span><br><span class="line">    <span class="variable">.din</span>                     ( din        [<span class="number">2</span>:<span class="number">0</span>] ),</span><br><span class="line">    <span class="variable">.choose</span>                  ( choose     [<span class="number">2</span>:<span class="number">0</span>] ),</span><br><span class="line">    <span class="variable">.confirm</span>                 ( confirm          ),</span><br><span class="line">    <span class="variable">.reconfirm</span>               ( reconfirm        ),</span><br><span class="line"></span><br><span class="line">    <span class="variable">.dout</span>                    ( dout             ),</span><br><span class="line">    <span class="variable">.change</span>                  ( change     [<span class="number">4</span>:<span class="number">0</span>] ),</span><br><span class="line">    <span class="variable">.empty_6</span>                 ( empty_6          )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span>  </span><br></pre></td></tr></tbody></table></figure><p><img src="/2021/10/19/%E7%8A%B6%E6%80%81%E6%9C%BA%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/%E4%BB%BF%E7%9C%9F.png" alt="仿真结果"></p><p> <a href="data.zip">点击下载仿真数据</a>  </p><p>仿真中choose信号的到来还未调整，但是功能是正常的。</p>]]></content>
      
      
      
        <tags>
            
            <tag> 状态机 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
